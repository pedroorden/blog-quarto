{"title":"Procesando datos de encuestas Con R","markdown":{"yaml":{"title":"Procesando datos de encuestas Con R","author":"Pedro Damian Orden","date":"2022-10-07","categories":["codigo","analisis","video","tutorial"],"image":"thumbnail.jpg","format":{"html":{"toc":true,"code-fold":true,"code-summary":"Ver código"}}},"headingText":"**Contenidos**","containsRefs":false,"markdown":"\n\nEl presente documento es un material de taller pensado para profesionales de las ciencias sociales y público interesado. Se procura aquí presentar de manera introductoria una serie de procedimientos asociados al procesamiento de encuestas con R.\n\nUna versión de este documento fue presentada en un Taller abierto del NIS el 16 de septiembre de 2022 y grabada en vivo para que todos y todas puedan replicar la experiencia código a código.\n\n```{r}\nlibrary(vembedr)\nembed_url(\"https://www.youtube.com/watch?v=mVqxiFUI6xA&ab_channel=ColegiodeSoci%C3%B3logxsBsAs\") %>%\n  use_align(\"center\")%>%\n  use_bs_responsive()\n```\n\nLas [diapositivas]{.ul} utilizadas en la primera parte del encuentro pueden encontrarse [**aquí**](https://www.canva.com/design/DAFLyN2w-ew/jJz7cs6igww-igO2nVoCeA/view \"presentación\").\n\n\nVeremos aquí:\n\n-   Carga de datos de un formulario drive y transformación.\n\n-   Análisis preliminar/exploratorio.\n\n-   Visualización.\n\n-   Recomendaciones profesionales: [skimr](https://docs.ropensci.org/skimr/), [esquisser](https://dreamrs.github.io/esquisse/) y [janitor](http://sfirke.github.io/janitor/).\n\n## Carga de datos\n\nLos datos de trabajo pertenecen a una sub-muestra de una encuesta realizada por los [Colegios Profesionales de Buenos Aires y el NIS](https://clip-urbano.com/2020/04/05/el-colegio-de-sociologos-invita-a-participar-de-una-encuesta-sobre-medios-e-informacion-en-tiempos-de-pandemia/) a comienzos de la pandemia, los mismos son 100% anónimos y fueron recabados por medio de un formulario Google.\n\nComenzamos cargando en R las respuestas de **drive** (previamente debemos compartirlo como público en la web, en formato *csv*) y creamos el objeto *muestra1*.\n\n```{r}\nmuestra1<-read.csv(\"https://docs.google.com/spreadsheets/d/e/2PACX-1vTbdWYdjYhfvt8quj9A5LpIEhH-sSKwxTsG8lKLLK_E_C5r1tkqFNdQNSAdzXvgthWCrFDn7oiN3-9P/pub?gid=346447959&single=true&output=csv\",encoding = \"UTF-8\")\n```\n\nExploramos con **funciones base** de R nuestros datos (todavía no estamos usando paquetes).\n\nIndagamos acerca de la clase de nuestros datos:\n\n```{r}\nclass(muestra1)\n```\n\nConsultamos la dimensión del conjunto de datos, filas y columnas:\n\n```{r}\ndim(muestra1)\n```\n\nY podríamos seguir así...pero no, cargamos el *(muy genial)* paquete [skimr](https://docs.ropensci.org/skimr/) el cual nos ayudará a crear un primer **resumen** de las características de nuestro set de datos (tengamos presente que para correr un paquete primero hay que instalarlo).\n\n```{r}\n#install.packages(\"skimr\") #lo grisado no se ejecuta\nlibrary(skimr)\nskim(muestra1)\n```\n\nUn resumen de nuestros datos con dos líneas de código, genial no? Este tipo de paquetes y funciones caracterizan a R, existen muchos desarrollos de la [comunidad](https://community.rstudio.com/) que pueden ayudarnos en nuestra labor diaria. Lo [importante]{.ul} es conocerlos y contar con el criterio de saber en qué momento y cómo usarlos.\n\n## Limpieza de datos\n\nComo hemos visto, tenemos una muestra de respondentes y la propuesta es ahora presentar algunos cálculos de estadística descriptiva y generar visualizaciones, ya que una parte importante de nuestro trabajo con encuestas tiene que ver con armar gráficos que reflejen el comportamiento de variables.\n\nAhora bien, antes de avanzar precisamos hacerle algunos ajustes a nuestros datos.\n\nPara llevar adelante este proceso vamos a cargar dos paquetes muy útiles para transformar datos -[tidyverse](https://www.tidyverse.org/)- y normalizar fechas -[lubridate](https://lubridate.tidyverse.org/)-.\n\n```{r warning=FALSE, message=FALSE}\n#install.packages(\"tidyverse\")\nlibrary(tidyverse)\n#install.packages(\"lubridate\")\nlibrary(lubridate)\n```\n\nCreamos el objeto muestra2, son nuestros datos de partida con *fechas* normalizadas y *espacios* en blanco reemplazados por *NAs* (mejora el procesamiento). Lo hacemos mediante las siguientes transformaciones:\n\n```{r}\nmuestra2<-muestra1%>% #pipe de tidyverse\n  mutate(Marca.temporal=sub(\" .*\", \"\", Marca.temporal))%>%\n  #transformamos nuestros datos\n  mutate(Marca.temporal=dmy(Marca.temporal))%>% #formateamos fecha\n  mutate_if(is.character, list(~na_if(.,\"\")))\n```\n\n## Primeras preguntas\n\nDado el ajuste rápido de nuestros datos, queremos conocer más sobre el proceso de campo del formulario, por ejemplo: entre qué fechas tuvo lugar y cuántos respondentes tuvo por día?\n\nVeamos qué podemos decir con nuestro objeto muestra2:\n\n```{r}\nrespuestas <- muestra2%>%\n  group_by(Marca.temporal)%>% #agrupamos por fecha\n  count() #contamos respuestas por fecha\n\nrespuestas\n```\n\nGraficamos las respuestas por día con [ggplot2](https://ggplot2.tidyverse.org/), una librería R que sirve para hacer gráficos. Viene con el paquete tidyverse que ya tenemos activado.\n\nVeamos como opera la lógica de estos gráficos en la práctica:\n\n```{r}\nrespuestas%>% #nuestro objeto\n  ggplot() + #declara la funcion para graficar el objeto\n  aes(x = Marca.temporal, y = n) + #idicamos las variables a graficar\n  geom_line(size = 0.5) #una geometria que la exprese, en este caso es una linea\n```\n\nVemos que el momento de nuestro campo tuvo un período de actividad desde finales de marzo y durante todo abril, luego registró respuestas esporádicas (por error).\n\nRepitamos el ejercicio poniendo nuestra atención en el lapso temporal en el que se registró la mayor cantidad de respuestas basándonos en la referencia visual que creamos.\n\n```{r}\nrespuestas%>%\n  filter(!Marca.temporal>=\"2020-05-01\")%>% #excluimos mayo 2020 en adelante\n  ggplot() + #declara la funcion para graficar el objeto\n  aes(x = Marca.temporal, y = n) + #una geometria que la exprese, en este caso es una linea\n  geom_line(size = 0.9) #aumentamos la linea\n```\n\nPresentamos ahora una tecnología *facilitadora* del proceso que acabamos de realizar.\n\n## Gráficos con la librería Esquisse\n\nAntes de contarles qué hace, veamos cómo funciona:\n\n```{r}\n#install.packages(\"esquisse\")\nlibrary(esquisse)\n# grisamos nuestro codigo como un machete.\n# lo a ctivamos para consulta \n# respuestas%>%\n#   esquisser()\n```\n\n> ***Importante**: se recomienda ver el video del inicio para acompañar la explicación acerca de como funciona esquisse.*\n\n[**Esquisse**](https://cran.r-project.org/web/packages/esquisse/vignettes/get-started.html) ayuda a explorar y visualizar nuestros datos de forma interactiva. El paquete crea gráficos ggplot de manera ágil por medio de una interfaz basada en arrastrar, soltar y filtrar para luego exportar los resultados como .png, .jpg o recuperar el código.\n\nPlantea dos utilidades principales:\n\n1.  **EDA al instante**: aunque ggplot es muy rápido y fácil de usar, esquisse permite explorar visualmente los datos en todos los ángulos con una variedad de tipos de gráficos, filtros, agrupaciones, etc.\n\n2.  **Conocer ggplot** : con este paquete se puede crear rápidamente un gráfico, mirar el código, hacer un cambio, ver cómo eso impactó en el código y repetir.\n\nComo se distribuye la variable edad de nuestra muestra? lo exploramos con esquisse.\n\n```{r}\n# muestra2%>%\n#   esquisser()\n\n# Cod: ejemplo\n  ggplot(muestra2) +\n  aes(x = X.Cuántos.años.tenés.) +\n  geom_histogram(bins = 10L, fill = \"#46337E\") +\n  labs(\n    x = \"años\",\n    y = \"n respondentes\",\n    title = \"Distribucion de la variable edad\",\n    subtitle = \"datos de muestra\"\n  ) +\n  theme_light()\n```\n\n## Calculemos porcentuales\n\nEl paquete [janitor](http://sfirke.github.io/janitor/) es otro aliado imprescindible ya que suma una una gama extra de funcionalidades a la hora de limpiar datos, entre las más destacables: genera nombres de columnas legibles, elimina columnas y filas vacías y encuentra valores duplicados. Aquí la usaremos para un proceso muy específico que es la creación de tablas de frecuencias y porcentuales.\n\n```{r warning=FALSE, message=FALSE}\n#install.packages(\"janitor\")\nlibrary(janitor)\n\ncuarentena<-muestra2%>%\n    tabyl(X.Estás.haciendo.cuarentena.)\n\nprint(cuarentena)\n```\n\nEl recorte de nuestra muestra indica que casi el 99% estaba haciendo cuarentena al momento de responder el formulario.\n\nCrucemos ahora estos datos con la variable de tenencia de hijos en edad escolar, para crear una tabla de doble entrada.\n\n```{r}\ncruce <- muestra2 %>%\n  rename(hace_home=X.Estas.trabajando.desde.tu.casa.bajo.alguna.modalidad.de.tele.trabajo..home.office..)%>%\n  tabyl(X.Tenes.hijos.en.edad.escolar., \n        hace_home,\n        show_na = FALSE)%>%\n  adorn_percentages(\"row\")\n\ncruce\n\n# y si lo esquisiamos (?\n# cruce%>%\n#   esquisser() #que pasa?\n```\n\nAsi como los estamos exportando no podemos graficarlos con ggplot ya que se multiplican las columnas con información. Para evitar que esto pase, un procedimiento habitual es volver a transformar nuestros datos en un par clave-valor.\n\n```{r}\ncruce2 <- cruce%>%\n  gather('hace_home', 'pct', c(2:4))%>% #reune varias columnas para convertirlas en un par clave-valor\n  mutate(pct=round(pct*100, 1))# formateamos porcentaje\n\nhead(cruce2)\n#checkeamos\n# cruce2%>%\n#   esquisser()\n```\n\nCon nuestro datos transformados podríamos generar un gráfico de base similar a este:\n\n```{r}\nggplot(cruce2) +\n aes(x = X.Tenes.hijos.en.edad.escolar., y = pct, fill = hace_home) +\n geom_col() +\n scale_fill_hue(direction = 1) +\n  theme(axis.text.x = element_text(angle = 45))\n```\n\n## Procesando variable de escala Likert\n\nO casi. Transformamos la pregunta: *en qué medida te sentís informado a acerca de las medidas de prevención del Coronavirus*, con una escala de 1 a 5, donde 1 es *nada informado/a* y 5 es *muy informado/a*.\n\n```{r}\nmuestra3<-muestra1%>%\n  rename(informa=X.En.qué.medida.te.sentís.informado.a.acerca.de.las.medidas.de.prevención.del.Coronavirus.)%>%\n  tabyl(informa, \n        show_na = FALSE)\n\nmuestra3<-muestra3%>%\n  mutate(percent=round(percent*100,1))%>%\n  mutate(informa=case_when(informa==1~\"1 nada informado/a\",\n                           informa==2~\"2 un poco informado/a\",\n                           informa==3~\"3 informado/a\",\n                           informa==4~\"4 bastante informado/a\",\n                           informa==5~\"5 muy informado/a\"))%>%\n  mutate(informa=as.factor(informa))\n\n#repetimos el esquisseo (??\n# muestra3%>%\n#   esquisser()\n```\n\n## Ejemplo: monitor socioeconómico\n\nEs un [tablero](https://pedroorden.shinyapps.io/socio-economico/) creado completamente en R que extrae los microdatos de la Encuesta Permanente de Hogares (INDEC), los procesa y visualiza de manera dinámica para conocer más sobre la coyuntura e historia reciente del mercado de trabajo y condiciones de vida en Argentina.\n\nSe trata de un proyecto en progreso del **NIS** que da cuenta de cómo podemos usar las nuevas herramientas de análisis y programación para automatizar y comunicar nuestro trabajo.\n\n## Bonus\n\nLa lógica de visualización no es solo para datos, ubicando puntos en los ejes **x** e **y** también podremos dibujar:\n\n```{r}\n\nseq(-2,2, by = 0.01) %>% \n  expand.grid(x=., y=.) %>% \n  ggplot(aes(x = x^3 - sin(y), y = y^3 - cos(x)))+\n  geom_point(alpha = 0.05, \n             color = \"#5E17EB\", shape = 20, size = 0)+ #https://www.color-hex.com/\n  theme_void()+\n  coord_polar()+\n  labs(subtitle = \"Llegamos al final de esta experiencia, gracias por participar\")\n```\n\nHasta la próxima!\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"index.html"},"language":{"code-summary":"Ver código"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","theme":"pulse","title-block-banner":true,"license":"CC BY","toc-title":"Table of contents","toc-location":"left","author":[{"name":null,"url":"https://linktr.ee/pedroorden","affiliation":"Núcleo de Innovación Social","affiliation-url":"https://www.nucleodeinnovacion.com/","orcid":"0000-0002-2254-8355"},"Pedro Damian Orden"],"citation":true,"title":"Procesando datos de encuestas Con R","date":"2022-10-07","categories":["codigo","analisis","video","tutorial"],"image":"thumbnail.jpg"},"extensions":{"book":{"multiFile":true}}}}}